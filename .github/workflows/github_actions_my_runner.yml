name: Danakini Danakinifinance Mobile Automation

on:
    workflow_dispatch:
        inputs:
            platform:
                description: "Select Platform"
                required: true
                default: "android"
                type: choice
                options:
                    - android
                    - ios
            device:
                description: "Input any device name"
                required: true
                default: "emulator-5554"
                type: string
            company:
                description: "Input any company name"
                required: true
                default: "Danakini"
                type: string
            userphone:
                description: "Input Test User Phone"
                required: false
                default: ""
                type: string
            userfullname:
                description: "Input Test User Full Name"
                required: false
                default: ""
                type: string
            userfullpin:
                description: "Input Test User Full PIN"
                required: false
                default: ""
                type: string

jobs:
    run-tests:
        runs-on: self-hosted
        env:
            PLATFORM: ${{ github.event.inputs.platform }}
            DEVICE: ${{ github.event.inputs.device }}
            COMPANY: ${{ github.event.inputs.company }}
            TEST_USER_PHONE: ${{ github.event.inputs.userphone }}
            TEST_USER_FULLNAME: ${{ github.event.inputs.userfullname }}
            TEST_USER_FULLPIN: ${{ github.event.inputs.userfullpin }}

        steps:
            - name: Checkout repo
              uses: actions/checkout@v3

            - name: Start Android Emulator
              if: ${{ github.event.inputs.platform == 'android' }}
              run: |
                  echo "ðŸ”„ Starting Android Emulator..."
                  nohup emulator -avd Pixel_8_Pro_API_36 > emulator.log 2>&1 &
                  adb wait-for-device
                  adb shell input keyevent 82
                  echo "âœ… Android Emulator is ready."

            - name: Show Current Working Directory
              run: pwd

            # iOS Simulator
            - name: Setup iOS Simulator & Install .app
              if: ${{ github.event.inputs.platform == 'ios' }}
              run: |
                  echo "ðŸ“¦ Unzipping .app ..."
                  pwd
                  ls -la
                  cd sample_applications
                  unzip sample_login_ios.zip

                  echo "ðŸ“² Booting iPhone 16 Pro Simulator..."
                  xcrun simctl boot "iPhone 16 Pro"
                  xcrun simctl bootstatus "iPhone 16 Pro" -b

            # Start Appium
            - name: Start Appium Server
              run: |
                  echo "ðŸš€ Starting Appium Server..."
                  nohup appium > appium.log 2>&1 &
                  sleep 5

                  - name: Run Tests (Android or iOS)
                  run: |
                    if [ "$PLATFORM" = "android" ]; then
                      npm run android.app.cucumber
                    elif [ "$PLATFORM" = "ios" ]; then
                      npm run ios.app.cucumber
                    else
                      echo "Unknown platform: $PLATFORM"
                      exit 1
                    fi

            - name: Generate Allure Report
              run: npm run allure:generate

            - name: Upload Allure Report
              uses: actions/upload-artifact@v4
              with:
                  name: allure-report
                  path: allure-report
